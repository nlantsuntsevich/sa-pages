<style>
  .loading {
    opacity: 0;
    transition: all 0.5s ease-in-out;
    filter: blur(5px);
    background-color: #f5f5f5;
  }
  .loaded {
    opacity: 1;
    filter: blur(0);
  }
  .mm-columns__item {
    background: #f5f5f5;
    min-height: 100px;
    position: relative;
    overflow: hidden;
  }
  .mm-columns__img {
    display: block;
    width: 100%;
    height: auto;
    will-change: opacity, filter;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const grid = document.querySelector(".mm-columns");

    // Initialize Masonry first
    const masonry = new Masonry(grid, {
      itemSelector: ".mm-columns__item",
      gutter: 10,
      initLayout: false,
    });

    // Function to handle image load with progressive enhancement
    function handleImageLoad(img) {
      requestAnimationFrame(() => {
        img.classList.add("loading");
        requestAnimationFrame(() => {
          img.classList.add("loaded");
          masonry.layout();
        });
      });
    }

    // Load images progressively using Intersection Observer
    const imageObserver = new IntersectionObserver(
      (entries, observer) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const img = entry.target;

            if (img.complete) {
              handleImageLoad(img);
            } else {
              img.addEventListener("load", () => handleImageLoad(img));
              img.addEventListener("error", () => {
                img.style.display = "none";
                masonry.layout();
              });
            }

            observer.unobserve(img);
          }
        });
      },
      {
        rootMargin: "50px",
        threshold: 0.1,
      }
    );

    // Observe all images
    const images = document.querySelectorAll(".mm-columns__img");
    images.forEach((img) => imageObserver.observe(img));

    // Initial layout
    masonry.layout();
  });
</script>

<div class="mm-columns">
  {% for item in site.data.index %}
  <div class="mm-columns__item">
    <a href="{{ item.src_url }}" target="_blank">
      <img
        class="mm-columns__img"
        src="{{ item.src_url }}"
        alt="{{ item.name }}"
        loading="lazy"
      />
    </a>
    <div class="overlay">{{ item.name }}</div>
  </div>
  {% endfor %}
</div>
# grid is broken, i need dynamic grid based on device size, mobile and desktop
#AI!
